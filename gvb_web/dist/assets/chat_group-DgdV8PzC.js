import{S as R,c as O,r as T,d as r,f as g,e,A as k,F as z,q as J,z as V,B as W,w as m,h,o as _,t as d,s as b,l as v,n as A,i as E}from"./index-CQKID6YZ.js";import{_ as F}from"./gvb_nav-DYuK08g5.js";import{a as w}from"./data-DE6nU9bg.js";import"./gvb_user_info-Htjmuczc.js";import"./logout-DE3wPEOl.js";import"./user_api-C9RnzkIX.js";import"./article_api-Cui2-luC.js";function K(f){return R.get("/api/chat_groups_records",{params:f})}const L={class:"base_view chat_group_view"},U={class:"gvb_inner_container"},I=e("div",{class:"gvb_chat_head"},[e("div",{class:"title"},"在线聊天室"),e("div",{class:"people_num"},"在线人数： 1")],-1),q={key:0,class:"in_room_msg"},D={key:1,class:"out_room_msg"},G={class:"avatar"},P=["src"],$={class:"message-main"},Q={class:"message-user"},X={class:"message-content"},Y={class:"content"},Z={class:"txt-message"},j=e("div",{class:"gvb_chat_menu"},[e("span",null,[e("i",{class:"fa fa-cloud-upload"})]),e("span",null,[e("i",{class:"fa fa-file-image-o"})]),e("span",null,[e("i",{class:"fa fa-file-audio-o"})])],-1),ee={class:"gvb_chat_footer"},S=1,x=2,H=7,ie={__name:"chat_group",setup(f){let n=null,p=0;const u=O(null),s=T({allHeight:"100vh",setHeight:"597px",message_list:[],user_info:{nick_name:"",avatar:""},content:""});async function N(){let o=document.documentElement.scrollHeight;s.allHeight=o+"px";let i=o-340;s.setHeight=i+"px";let l=await K({limit:50});s.message_list=l.data.list,s.message_list.reverse();let c;console.log("WebSocket URL:",c),c===void 0&&(c="/ws/"),n=new WebSocket(c+"/chat_groups"),n.onmessage=B,n.onopen=function(a){var t={content:"",msg_type:S};n.send(JSON.stringify(t)),console.log("onopen: ",a)},n.onclose=function(a){var t={content:"",msg_type:H};n.send(JSON.stringify(t)),console.log("onopen: ",a)},n.onerror=function(a){console.log("onerror: ",a)},n.onclose=function(a){console.log("onclose: ",a)}}function B(o){let i=o.data,l=JSON.parse(i);if(p===0){s.user_info.nick_name=l.nick_name,p++;return}C(l),p++}function C(o){console.log(o),o.nick_name===s.user_info.nick_name&&(o.is_me=!0),s.message_list.push(o),s.message_list=[...s.message_list]}function y(){let o={content:s.content,msg_type:x};n.readyState===WebSocket.OPEN?(n.send(JSON.stringify(o)),s.content=""):console.error("WebSocket is not open. Current state: "+n.readyState),setTimeout(()=>{let i=u.value.scrollHeight,l=u.value.clientHeight,c=null;c=setInterval(()=>{let a=u.value.scrollTop;if(i<=a+l){clearInterval(c);return}u.value.scrollTop+=20},5)},100)}return N(),(o,i)=>{const l=h("a-tooltip"),c=h("a-textarea"),a=h("a-button");return _(),r("div",L,[g(F,{is_show:""}),e("div",{class:"gvb_base_container",style:k({height:s.allHeight})},[e("div",U,[I,e("div",{class:"gvb_chat_body",ref_key:"chatBody",ref:u,style:k({height:s.setHeight})},[(_(!0),r(z,null,J(s.message_list,(t,M)=>(_(),r("div",{class:"message",key:M},[t.msg_type===S?(_(),r("div",q,[g(l,{placement:"top"},{title:m(()=>[e("span",null,d(b(w)(t.created_at)),1)]),default:m(()=>[e("span",null,d(t.content),1)]),_:2},1024)])):v("",!0),t.msg_type===H?(_(),r("div",D,[g(l,{placement:"top"},{title:m(()=>[e("span",null,d(b(w)(t.created_at)),1)]),default:m(()=>[e("span",null,d(t.content),1)]),_:2},1024)])):v("",!0),t.msg_type===x?(_(),r("div",{key:2,class:A({me:t.is_me})},[e("div",G,[e("img",{src:t.avatar,alt:""},null,8,P)]),e("div",$,[e("div",Q,d(t.nick_name),1),e("div",X,[e("div",Y,[e("div",Z,d(t.content),1)])])])],2)):v("",!0)]))),128))],4),j,e("div",ee,[g(c,{value:s.content,"onUpdate:value":i[0]||(i[0]=t=>s.content=t),placeholder:"发送你的消息，聊起来吧",onKeydown:V(W(y,["ctrl"]),["enter"]),"auto-size":{minRows:4,maxRows:4}},null,8,["value","onKeydown"]),g(a,{onClick:y,class:"chat_btn"},{default:m(()=>[E("发送")]),_:1})])])],4)])}}};export{ie as default};
