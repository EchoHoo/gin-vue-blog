import{S as M,c as O,r as T,d as i,f as g,e,A as k,F as z,q as J,z as L,B as U,w as m,h,o as r,t as _,s as b,l as v,n as V,i as W}from"./index-DhileAJB.js";import{_ as A}from"./gvb_nav-CQVDcoIK.js";import{a as w}from"./data-DE6nU9bg.js";import"./gvb_user_info-8kjrVEN8.js";import"./logout-Be_vOF8P.js";import"./user_api-DGC5Xh6o.js";import"./article_api-D064_192.js";function E(f){return M.get("/api/chat_groups_records",{params:f})}const F={class:"base_view chat_group_view"},K={class:"gvb_inner_container"},I=e("div",{class:"gvb_chat_head"},[e("div",{class:"title"},"在线聊天室"),e("div",{class:"people_num"},"在线人数： 1")],-1),q={key:0,class:"in_room_msg"},D={key:1,class:"out_room_msg"},G={class:"avatar"},P=["src"],$={class:"message-main"},Q={class:"message-user"},X={class:"message-content"},Y={class:"content"},Z={class:"txt-message"},j=e("div",{class:"gvb_chat_menu"},[e("span",null,[e("i",{class:"fa fa-cloud-upload"})]),e("span",null,[e("i",{class:"fa fa-file-image-o"})]),e("span",null,[e("i",{class:"fa fa-file-audio-o"})])],-1),ee={class:"gvb_chat_footer"},S=1,x=2,H=7,ie={__name:"chat_group",setup(f){let n=null,p=0;const d=O(null),s=T({allHeight:"100vh",setHeight:"597px",message_list:[],user_info:{nick_name:"",avatar:""},content:""});async function N(){let o=document.documentElement.scrollHeight;s.allHeight=o+"px";let c=o-340;s.setHeight=c+"px";let l=await E({limit:50});s.message_list=l.data.list,s.message_list.reverse(),console.log("WebSocket URL:",void 0),n=new WebSocket("ws://127.0.0.1:10800/ws/chat_groups"),n.onmessage=R,n.onopen=function(a){var t={content:"",msg_type:S};n.send(JSON.stringify(t)),console.log("onopen: ",a)},n.onclose=function(a){var t={content:"",msg_type:H};n.send(JSON.stringify(t)),console.log("onopen: ",a)},n.onerror=function(a){console.log("onerror: ",a)},n.onclose=function(a){console.log("onclose: ",a)}}function R(o){let c=o.data,l=JSON.parse(c);if(p===0){s.user_info.nick_name=l.nick_name,p++;return}B(l),p++}function B(o){console.log(o),o.nick_name===s.user_info.nick_name&&(o.is_me=!0),s.message_list.push(o),s.message_list=[...s.message_list]}function y(){let o={content:s.content,msg_type:x};n.readyState===WebSocket.OPEN?(n.send(JSON.stringify(o)),s.content=""):console.error("WebSocket is not open. Current state: "+n.readyState),setTimeout(()=>{let c=d.value.scrollHeight,l=d.value.clientHeight,u=null;u=setInterval(()=>{let a=d.value.scrollTop;if(c<=a+l){clearInterval(u);return}d.value.scrollTop+=20},5)},100)}return N(),(o,c)=>{const l=h("a-tooltip"),u=h("a-textarea"),a=h("a-button");return r(),i("div",F,[g(A,{is_show:""}),e("div",{class:"gvb_base_container",style:k({height:s.allHeight})},[e("div",K,[I,e("div",{class:"gvb_chat_body",ref_key:"chatBody",ref:d,style:k({height:s.setHeight})},[(r(!0),i(z,null,J(s.message_list,(t,C)=>(r(),i("div",{class:"message",key:C},[t.msg_type===S?(r(),i("div",q,[g(l,{placement:"top"},{title:m(()=>[e("span",null,_(b(w)(t.created_at)),1)]),default:m(()=>[e("span",null,_(t.content),1)]),_:2},1024)])):v("",!0),t.msg_type===H?(r(),i("div",D,[g(l,{placement:"top"},{title:m(()=>[e("span",null,_(b(w)(t.created_at)),1)]),default:m(()=>[e("span",null,_(t.content),1)]),_:2},1024)])):v("",!0),t.msg_type===x?(r(),i("div",{key:2,class:V({me:t.is_me})},[e("div",G,[e("img",{src:t.avatar,alt:""},null,8,P)]),e("div",$,[e("div",Q,_(t.nick_name),1),e("div",X,[e("div",Y,[e("div",Z,_(t.content),1)])])])],2)):v("",!0)]))),128))],4),j,e("div",ee,[g(u,{value:s.content,"onUpdate:value":c[0]||(c[0]=t=>s.content=t),placeholder:"发送你的消息，聊起来吧",onKeydown:L(U(y,["ctrl"]),["enter"]),"auto-size":{minRows:4,maxRows:4}},null,8,["value","onKeydown"]),g(a,{onClick:y,class:"chat_btn"},{default:m(()=>[W("发送")]),_:1})])])],4)])}}};export{ie as default};
